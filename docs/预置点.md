# 云台预置点操作说明（PTZ Preset）

## 5.6.5 云台预置点操作（NET_DVR_PTZPreset）

### 函数原型

```c
BOOL NET_DVR_PTZPreset(
    LONG  lRealHandle,
    DWORD dwPTZPresetCmd,
    DWORD dwPresetIndex
);
```

### 参数说明

| 参数名              | 类型    | 方向 | 说明                          |
| ---------------- | ----- | -- | --------------------------- |
| `lRealHandle`    | LONG  | in | `NET_DVR_RealPlay_V40` 的返回值 |
| `dwPTZPresetCmd` | DWORD | in | 云台预置点操作命令（见下表 5.11）         |
| `dwPresetIndex`  | DWORD | in | 预置点序号（1-255）                |

### 返回值

* `TRUE`：表示成功
* `FALSE`：表示失败

  * 失败时请调用 `NET_DVR_GetLastError()` 获取错误码排查问题。

### 说明

* 需 **先启动预览** 后才能调用此接口。
* CVR 设备在“通道模式”下支持，“流 ID 模式”不支持。
* PTZ 操作依赖设备中设置的解码器类型和地址，如不匹配需重新配置。
* 若云台设备不支持当前解码器协议，则无法通过该接口控制。

---

## 表 5.11 预置点操作命令

| 宏定义           | 宏定义值 | 含义    |
| ------------- | ---- | ----- |
| `SET_PRESET`  | 8    | 设置预置点 |
| `CLE_PRESET`  | 9    | 清除预置点 |
| `GOTO_PRESET` | 39   | 转到预置点 |

---

## 5.6.6 云台预置点操作（NET_DVR_PTZPreset_Other）

### 函数原型

```c
BOOL NET_DVR_PTZPreset_Other(
    LONG  lUserID,
    LONG  lChannel,
    DWORD dwPTZPresetCmd,
    DWORD dwPresetIndex
);
```

### 参数说明

| 参数名              | 类型    | 方向 | 说明                            |
| ---------------- | ----- | -- | ----------------------------- |
| `lUserID`        | LONG  | in | 登录句柄，`NET_DVR_Login_V40` 的返回值 |
| `lChannel`       | LONG  | in | 通道号                           |
| `dwPTZPresetCmd` | DWORD | in | 云台预置点操作命令（见表 5.11）            |
| `dwPresetIndex`  | DWORD | in | 预置点序号（1-255）                  |

### 返回值

* `TRUE`：表示成功
* `FALSE`：失败，调用 `NET_DVR_GetLastError()` 查看错误码。

### 说明

* CVR 设备在“通道模式”下支持，“流 ID 模式”不支持。
* 与设备之间的云台控制命令会转换为设备内部的控制码，由设备向云台发送。
* 解码器配置不匹配会导致控制失败。
* **与 `NET_DVR_PTZPreset` 不同：**

  * `NET_DVR_PTZPreset`：设备执行完成动作后才返回成功
  * `NET_DVR_PTZPreset_Other`：设备**接收命令即返回成功**，不等待实际动作结果

---

## Go 调用示例

### 使用 NET_DVR_PTZPreset（需要先启动预览）

```go
// 先启动预览获取句柄
receiver := &core.Receiver{}
receiver.Start()
lRealHandle, err := dev.RealPlay_V40(channelId, receiver)
if err != nil {
    log.Fatal("启动预览失败:", err)
}
defer dev.StopRealPlay()

// 设置预置点 1
ok, err := dev.PTZPreset(core.SET_PRESET, 1)
if err != nil {
    fmt.Println("设置预置点失败:", err)
}

// 转到预置点 1
ok, err = dev.PTZPreset(core.GOTO_PRESET, 1)

// 清除预置点 1
ok, err = dev.PTZPreset(core.CLE_PRESET, 1)
```

### 使用 NET_DVR_PTZPreset_Other（推荐，不需要预览）

```go
channelId := 1  // 通道号
presetId := 1   // 预置点编号

// 设置预置点
ok, err := dev.PTZPreset_Other(channelId, core.SET_PRESET, presetId)
if err != nil {
    fmt.Printf("设置预置点失败: %v\n", err)
} else {
    fmt.Printf("预置点 %d 设置成功\n", presetId)
}

// 移动云台到其他位置
dev.PTZControlWithSpeed_Other(channelId, core.PAN_RIGHT, 0, 3)
time.Sleep(3 * time.Second)
dev.PTZControlWithSpeed_Other(channelId, core.PAN_RIGHT, 1, 3)

// 转到预置点
ok, err = dev.PTZPreset_Other(channelId, core.GOTO_PRESET, presetId)
if err != nil {
    fmt.Printf("转到预置点失败: %v\n", err)
} else {
    fmt.Printf("正在转到预置点 %d\n", presetId)
}

// 清除预置点
ok, err = dev.PTZPreset_Other(channelId, core.CLE_PRESET, presetId)
if err != nil {
    fmt.Printf("清除预置点失败: %v\n", err)
}
```

### 完整示例

查看 `examples/ptz_control.go` 了解更多 PTZ 控制示例。

## 常见错误码

| 错误码 | 说明 | 解决方案 |
|------|------|---------|
| 23 | 不支持该操作 | 检查设备是否支持 PTZ 功能，通道是否为 PTZ 通道 |
| 7 | 连接服务器失败 | 检查网络连接和设备状态 |
| 1 | 用户名密码错误 | 检查登录凭据 |
| 17 | 参数错误 | 检查预置点编号是否在 1-255 范围内 |

