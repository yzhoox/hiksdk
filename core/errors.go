package core

/*
#include <stdio.h>
#include <stdlib.h>
#include "hiksdk_wrapper.h"
*/
import "C"
import (
	"encoding/json"
	"fmt"
)

// HKError 海康SDK错误结构体
// 封装了错误码、错误消息和相关上下文信息
type HKError struct {
	Code      int    `json:"code"`      // 错误码
	Msg       string `json:"msg"`       // 错误消息
	Operation string `json:"operation"` // 操作名称
	IP        string `json:"ip"`        // 设备IP地址
}

// Error 实现error接口
func (e *HKError) Error() string {
	return fmt.Sprintf("code=%d, msg=%s, operation=%s, ip=%s", e.Code, e.Msg, e.Operation, e.IP)
}

// JSON 返回错误的JSON格式字符串
func (e *HKError) JSON() string {
	data, _ := json.Marshal(e)
	return string(data)
}

// HKErr 创建海康SDK错误
// 自动获取最后的错误码和错误消息
// 参数：
//   - operation: 操作名称，用于标识出错的操作
//
// 返回值：
//   - *HKError: 错误对象
func (device *HKDevice) HKErr(operation string) *HKError {
	errorCode := int(C.NET_DVR_GetLastError())
	errorMsg := getErrorMsg(errorCode)
	
	return &HKError{
		Code:      errorCode,
		Msg:       errorMsg,
		Operation: operation,
		IP:        device.ip,
	}
}

// getErrorMsg 根据错误码获取错误消息
// 包含了海康SDK的常见错误码及其说明
func getErrorMsg(code int) string {
	errorMsgs := map[int]string{
		0:   "没有错误",
		1:   "用户名或密码错误",
		2:   "权限不足",
		3:   "SDK未初始化",
		4:   "通道号错误，设备没有对应的通道号",
		5:   "设备总的连接数超过最大",
		6:   "版本不匹配",
		7:   "连接设备失败，设备不在线或网络原因引起的连接超时",
		8:   "向设备发送失败",
		9:   "从设备接收数据失败",
		10:  "从设备接收数据超时",
		11:  "传送的数据有误",
		12:  "调用次序错误",
		13:  "无此权限",
		14:  "设备命令执行超时",
		15:  "串口号错误",
		16:  "报警端口错误",
		17:  "参数错误",
		18:  "设备通道处于录像状态",
		20:  "设备相关",
		23:  "设备不支持该功能",
		24:  "设备正忙",
		25:  "设备操作失败",
		26:  "语音对讲被其他用户占用",
		27:  "设备不支持该操作",
		28:  "输入输出参数不匹配",
		29:  "设置布防时间失败",
		30:  "用户数达到最大",
		31:  "获取设备参数失败",
		32:  "不支持该报警类型",
		33:  "加载相关组件库失败",
		34:  "启动录音卡失败",
		35:  "没有足够的带宽",
		36:  "IP地址不匹配",
		37:  "MAC地址不匹配",
		38:  "升级文件版本不匹配",
		39:  "播放器路数达到最大",
		40:  "保存数据失败",
		41:  "端口重复",
		42:  "网络断开连接",
		43:  "账号被锁定",
		44:  "缓冲区太小",
		45:  "没有硬盘",
		46:  "图片参数不正确",
		47:  "解码失败",
		48:  "创建文件失败",
		49:  "打开文件失败",
		50:  "系统调用失败",
		51:  "互斥等待超时",
		52:  "配置文件有误",
		53:  "用户取消操作",
		54:  "功能未完成",
		55:  "没有格式化硬盘",
		56:  "正在格式化，不能操作",
		57:  "没有安装存储设备",
		58:  "正在操作",
		59:  "透传通道建立失败",
		60:  "透传通道已建立",
		61:  "通道已关闭",
		62:  "流ID无效",
		63:  "解码类型不支持",
		64:  "文件太短或无录像文件",
		65:  "拖动播放位置失败",
		66:  "加载当前目录下Player Sdk出错",
		67:  "找不到Player Sdk中某个函数入口",
		68:  "播放器打开文件失败",
		69:  "播放器创建定时器失败",
		70:  "录像数据校验失败",
		71:  "录像文件版本号不匹配",
		72:  "热备设备工作于备用状态",
		73:  "转码失败",
		74:  "正在转封装",
		75:  "超时",
		76:  "用户取消",
		77:  "备份时写文件失败",
		78:  "不能备份到只读文件系统",
		79:  "该版本不支持此功能",
		80:  "网络数据接收超时",
		81:  "网络数据发送超时",
		82:  "网络数据接收失败",
		83:  "网络数据发送失败",
		84:  "服务器返回错误",
		85:  "没有匹配的结果",
		86:  "没有相应的上传通道资源",
		87:  "磁盘空间不足",
		88:  "设备操作失败",
		89:  "语音资源被占用",
		90:  "内存异常",
		91:  "文件内容不匹配",
		92:  "缓存无数据",
		93:  "正在处理数据",
		94:  "正在播放，请先停止",
		95:  "用户名已经存在",
		96:  "和已有的配置冲突",
		97:  "设备正在升级，请稍后",
		98:  "通道重复导入",
		99:  "SSL连接失败",
		100: "设备证书验证失败",
		101: "添加相同类型的布防类型",
		102: "没有对应域名的证书",
		150: "别名重复",
		151: "用户名不存在",
		152: "用户被锁定",
		153: "无效用户ID",
		154: "登录密码错误",
		155: "密码不能带空格",
		156: "密码已经被重置",
		157: "账户不存在",
		158: "账户未激活",
		159: "管理员密码不正确",
		160: "管理员密码不匹配",
		161: "账号受限，没有任何本地权限",
		162: "设备账户数已满",
		163: "访客账户，登录被拒绝",
		164: "设备用户已满",
		401: "SDK加载动态库失败",
		402: "SDK加载动态库函数失败",
		403: "SDK缓存已满",
		404: "达到码流上限",
		405: "码流封装格式错误",
		406: "码流封装版本不匹配",
		407: "加载解码库失败",
		408: "查找相关文件失败",
		409: "创建日志文件目录失败",
		410: "绑定本地UDP端口失败",
		411: "socket连接失败",
		412: "传输缓冲区满",
		413: "通道需要解密",
		424: "预览组件加载失败",
		425: "报警组件加载失败",
		426: "回放组件加载失败",
		427: "显示组件加载失败",
		428: "行业组件加载失败",
		429: "通用配置管理组件加载失败",
		430: "Core组件加载失败",
		431: "语音对讲组件加载失败",
		432: "正在加载组件",
		433: "组件启动服务失败",
		434: "输入的IP为IPV6",
		436: "输入的IP为IPV4",
		437: "CA证书不匹配",
		438: "API不支持该功能",
		439: "设备池信息重复",
		440: "没有对应的设备池",
		441: "批量配置功能组件加载失败",
		442: "安防平台组件加载失败",
		443: "缺少依赖库",
		444: "不支持的操作系统",
		445: "不支持的处理器平台",
		446: "语音转发组件加载失败",
		447: "用户名或密码带有非法字符",
		448: "IP和端口冲突",
		449: "设备管家组件加载失败",
		450: "内部参数错误",
		451: "不支持的SDK类型",
		501: "TLS建立失败",
		502: "回调时句柄出错",
		503: "Qos流控队列满",
		504: "SDK内部异常",
		505: "SDK内部错误码",
		507: "未启用证书验证",
		508: "设备通信库组件加载失败",
		509: "未初始化或者初始化错误",
		510: "未加载设备通信库组件",
		511: "未启用双向认证",
		512: "服务器证书未提供",
		513: "客户端证书未提供",
		514: "客户端证书密钥未提供",
		515: "协议栈中缓存的待发送的报文数目超过最大值",
		516: "加解密数据失败",
		517: "解析XML出错",
		518: "函数传入传出参数错误",
		519: "当前时间许可证不可用",
		520: "重复登录",
		521: "Json操作失败",
		522: "加密资源错误",
		523: "加密数据操作失败",
		524: "加密数据验证失败",
		525: "解密失败，密码错误或者文件被篡改",
		526: "未授权的功能资源",
		800: "设备不在线",
	}
	
	if msg, exists := errorMsgs[code]; exists {
		return msg
	}
	return fmt.Sprintf("未知错误码: %d", code)
}
